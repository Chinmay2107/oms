<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="get" noun="TransferOrder">
        <description>
            Service to get Transfer Order Details.
        </description>
        <in-parameters>
            <parameter name="orderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="order" type="Map">
                <parameter name="orderId"/>
                <parameter name="orderStatusDesc"/>
                <parameter name="orderName"/>
                <parameter name="orderExternalId"/>
                <parameter name="orderStatusId"/>
                <parameter name="orderItems" type="List">
                    <parameter name="orderItemMap" type="Map">
                        <parameter name="orderItemSeqId"/>
                        <parameter name="shipGroupSeqId"/>
                        <parameter name="quantity"/>
                        <parameter name="statusId"/>
                        <parameter name="productId"/>
                        <parameter name="totalIssuedQuantity"/>
                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <set field="order" from="[:]"/>

            <entity-find entity-name="co.hotwax.oms.order.OrderHeaderItemShipGroup" list="orders" distinct="true">
                <econdition field-name="orderId" from="orderId"/>
                <select-field field-name="orderId,orderName,orderExternalId,orderStatusId,orderStatusDesc"/>
            </entity-find>

            <set field="order" from="orders.first.getPlainValueMap(0)"/>

            <!-- Get Order Item details -->
            <entity-find entity-name="org.apache.ofbiz.order.order.OrderItem" list="orderItemList">
                <econdition field-name="orderId"/>
                <select-field field-name="orderItemSeqId,shipGroupSeqId,productId,quantity,statusId"/>
            </entity-find>
            <set field="order.orderItems" from="orderItemList?.getPlainValueList(0)"/>

            <iterate list="order.orderItems" entry="orderItem">
                <!-- Get total issued quantity -->
                <entity-find entity-name="co.hotwax.shipment.ItemIssuanceSummary" list="itemIssuanceList">
                    <econdition field-name="orderId"/>
                    <econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/>
                    <select-field field-name="orderId,orderItemSeqId,quantity"/>
                </entity-find>
                <set field="orderItem.totalIssuedQuantity" from="itemIssuanceList?.first?.quantity"/>
            </iterate>
        </actions>
    </service>
</services>