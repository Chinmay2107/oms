<?xml version="1.0" encoding="UTF-8"?>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <!-- TODO Corresponding commerce TO screens need to be fixed.
            NOTE: OISGA records are not created for the transfer order here, but the earlier impl creates
            OISGA records and the commerce screens still use references of OISGA.
            The shipGroupSeqId reference is saved in OrderItem and should be fetched from there, this impl
            will not support backward compatibility, so the screens need to be fixed. -->
    <service verb="create" noun="TransferOrder">
        <description>
            Service to create Transfer Order.
            The Order and Items are created in ORDER_CREATED and ITEM_CREATED status respectively.
        </description>
        <in-parameters>
            <parameter name="payload" type="Map" required="true">
                <parameter name="externalId">
                    <description>The ID of the Transfer Order in the external system.</description>
                </parameter>
                <parameter name="orderName">
                    <description>The Transfer Order name.</description>
                </parameter>
                <parameter name="statusFlowId">
                    <description>The Status Flow ID in OMS for the Transfer Order Item status transitions.</description>
                </parameter>
                <parameter name="productStoreId">
                    <description>The ID of the Product Store in OMS.</description>
                </parameter>
                <parameter name="originFacilityId">
                    <description>The ID of the Facility in OMS for the origin location of the Transfer Order.</description>
                </parameter>
                <parameter name="orderDate">
                    <description>The date when the Transfer Order was placed.</description>
                </parameter>
                <parameter name="shipGroups" type="List">
                    <parameter name="shipGroupMap" type="Map">
                        <parameter name="destinationFacilityId">
                            <description>The ID of the Facility in OMS for the destination location of the Transfer Order.</description>
                        </parameter>
                        <parameter name="shipmentMethodTypeId">
                            <description>The ID of the Shipment Method in OMS for the Transfer Order.</description>
                        </parameter>
                        <parameter name="carrierPartyId">
                            <description>The ID of the Carrier Party in OMS for the Transfer Order.</description>
                        </parameter>
                        <parameter name="items" type="List">
                            <parameter name="itemMap" type="Map">
                                <parameter name="productId">
                                    <description>The ID of the product in OMS for the Transfer Order Item.</description>
                                </parameter>
                                <parameter name="externalId">
                                    <description>The ID of the product in external system for the Transfer Order Item.</description>
                                </parameter>
                                <parameter name="quantity" type="Integer">
                                    <description>The quantity of the item ordered in the Transfer Order.</description>
                                </parameter>
                            </parameter>
                        </parameter>
                    </parameter>
                </parameter>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId">
                <description>The ID of the Transfer Order created in OMS.</description>
            </parameter>
        </out-parameters>
        <actions>
            <!-- Get Product Store to set default values like sales channel and currency if not in the payload -->
            <entity-find-one entity-name="org.apache.ofbiz.product.store.ProductStore" value-field="productStore" cache="true">
                <field-map field-name="productStoreId" from="payload.productStoreId"/>
            </entity-find-one>

            <set field="payload.salesChannelEnumId" from="payload.salesChannelEnumId ?: productStore?.defaultSalesChannelEnumId"/>
            <set field="payload.currencyUom" from="payload.currencyUom ?: productStore?.defaultCurrencyUomId"/>

            <set field="payload.orderTypeId" value="TRANSFER_ORDER"/>
            <set field="payload.entryDate" from="ec.user.nowTimestamp"/>

            <!-- Instead of adding validations on statusId, the service always sets ORDER_CREATED status for TO creation -->
            <set field="payload.statusId" value="ORDER_CREATED"/>

            <set field="payload.createdBy" from="ec.user.getUsername()?:ec.user.getUserId()"/>

            <!-- Set originFacilityId as facilityId for OrderItemShipGroup -->
            <set field="payload.shipGroups*.facilityId" from="payload.originFacilityId"/>

            <iterate list="payload.shipGroups" entry="shipGroup">
                <!-- Set destinationFacilityId as orderFacilityId for OrderItemShipGroup -->
                <set field="shipGroup.orderFacilityId" from="shipGroup.remove('destinationFacilityId')"/>

                <!-- Set default values for Order Item -->
                <set field="shipGroup.items*.orderItemTypeId" value="PRODUCT_ORDER_ITEM"/>
                <!-- Instead of adding validations on statusId, the service always sets ITEM_CREATED status for TO item creation -->
                <set field="shipGroup.items*.statusId" value="ITEM_CREATED"/>
            </iterate>

            <service-call name="create#org.apache.ofbiz.order.order.OrderHeader" in-map="payload" out-map="orderOut"/>
            <set field="orderId" from="orderOut.orderId"/>
            <if condition="orderId">
                <log level="info" message="Creating order index for oms orderId : ${orderId}"/>
                <service-call name="co.hotwax.oms.search.SearchServices.index#OrderHeader" in-map="[orderId:orderId]"
                        async="true" ignore-error="true"/>
            </if>
        </actions>
    </service>

    <service verb="approve" noun="TransferOrder" transaction-timeout="300">
        <description>
            Service to approve Transfer Order.
            The Order will be updated to ORDER_APPROVED status. The Items will be updated to the next eligible Item
            Status for "Approve Item" transition based on the statusFlowId associated with the Transfer Order.
        </description>
        <in-parameters>
            <parameter name="orderId" required="true">
                <description>The internal ID of the Transfer Order in OMS.</description>
            </parameter>
        </in-parameters>
        <actions>
            <!-- Get Order Header -->
            <entity-find-one entity-name="org.apache.ofbiz.order.order.OrderHeader" value-field="orderHeader"/>
            <set field="statusFlowId" from="orderHeader?.statusFlowId"/>

            <!-- Update the order status to ORDER_APPROVED -->
            <service-call name="co.hotwax.oms.order.OrderServices.change#OrderStatus" in-map="[orderId:orderId, statusId:'ORDER_APPROVED']"/>

            <!-- Get the item status for based on statusFlowId for approving order item -->
            <entity-find entity-name="moqui.basic.StatusFlowTransition" list="statusFlowTransitionList">
                <econdition field-name="statusFlowId"/>
                <econdition field-name="transitionSequence" value="1"/>
                <!-- TODO below check could be avoided since transitionSequence=1 is used?
                        or we could only add condition on transitionName="Approve Item" -->
                <econdition field-name="statusId" value="ITEM_CREATED"/>
            </entity-find>
            <set field="itemToStatusId" from="statusFlowTransitionList?.first?.toStatusId"/>

            <if condition="!itemToStatusId">
                <return error="true" message="Cannot Approve Order ID [${orderId}] - Missing Status Flow transition for Approve Item"/>
            </if>

            <!-- Get Ship Groups -->
            <entity-find-related value-field="orderHeader" relationship-name="org.apache.ofbiz.order.order.OrderItemShipGroup" list="shipGroupList"/>

            <iterate list="shipGroupList" entry="shipGroup">
                <!-- Get Order Items -->
                <entity-find-related value-field="shipGroup" relationship-name="org.apache.ofbiz.order.order.OrderItem" list="orderItemList"/>

                <!-- Update Item Status and Reserve the item if item's next status is ITEM_PENDING_FULFILL -->
                <iterate list="orderItemList" entry="orderItem">
                    <!-- Update the order item status -->
                    <service-call name="co.hotwax.oms.order.OrderServices.change#OrderItemStatus"
                            in-map="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId, statusId:itemToStatusId,
                            checkCancelCompleteOrder:false]"/>

                    <if condition="'ITEM_PENDING_FULFILL'.equals(itemToStatusId)">
                        <!-- Check if multiple times reservation done if order approved again,
                                - done, this returns error for duplicate entry of OISGR, so this should be good. -->
                        <service-call name="co.hotwax.oms.impl.OrderReservationServices.create#OrderItemInventoryReservation"
                                in-map="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId, quantity:orderItem.quantity]"/>
                    </if>
                </iterate>
            </iterate>

            <!-- Update Order Index for change in order and item status -->
            <log level="info" message="Creating order index for oms orderId : ${orderId} in Approve Transfer Order"/>
            <service-call name="co.hotwax.oms.search.SearchServices.index#OrderHeader" in-map="[orderId:orderId]"
                    async="true" ignore-error="true"/>
        </actions>
    </service>
</services>
