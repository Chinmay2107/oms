<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://moqui.org/xsd/service-definition-3.xsd">
    <service verb="find" noun="OrderItemShipGroup">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="facilityId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="shipGroupSeqId"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="org.apache.ofbiz.product.facility.Facility" value-field="facility" cache="true"/>
            <service-call name="co.hotwax.oms.common.CommonServices.check#ParentType"
                          in-map="[entityName: 'org.apache.ofbiz.product.facility.FacilityType',
                                primaryKey: 'facilityTypeId',
                                childType: facility.facilityTypeId,
                                parentTypeField: 'parentTypeId',
                                parentType: 'VIRTUAL_FACILITY']" out-map="outResult"/>
            <!-- Since a new ShipGroup is created for each routing attempt,
                 reuse the existing ShipGroup only if the facility type is "virtual".
                Additionally, filtering based on the shipment method type may be required in future.
            -->
            <if condition="outResult.hasParentType">
                <entity-find entity-name="org.apache.ofbiz.order.order.OrderItemShipGroup" list="orderItemShipGroups">
                    <econdition field-name="orderId" from="orderId"/>
                    <econdition field-name="facilityId" from="facilityId"/>
                    <order-by field-name="shipGroupSeqId DESC"/>
                </entity-find>
                <if condition="orderItemShipGroups">
                    <set field="orderItemShipGroup" from="orderItemShipGroups[0]"/>
                    <set field="shipGroupSeqId" from="orderItemShipGroup.shipGroupSeqId"/>
                    <return/>
                </if>
            </if>
        </actions>
    </service>
</services>